<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Laporan Keuangan - PAUD UNDIP</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; font-size: 10pt; line-height: 1.4; color: #1a1a1a; }
        .container { padding: 20px; }
        
        .header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #1e40af; }
        .header h1 { font-size: 18pt; color: #1e40af; margin-bottom: 3px; font-weight: bold; }
        .header h2 { font-size: 12pt; color: #64748b; font-weight: normal; margin-bottom: 10px; }
        .header .metadata { font-size: 9pt; color: #64748b; }
        .payment-info { display: inline-block; background: #dbeafe; padding: 4px 12px; border-radius: 4px; color: #1e40af; font-weight: 600; margin-top: 8px; }
        
        .summary-grid { display: table; width: 100%; margin: 20px 0; border-collapse: collapse; }
        .summary-row { display: table-row; }
        .summary-cell { display: table-cell; padding: 12px; border: 1px solid #e2e8f0; background: #f8fafc; width: 25%; vertical-align: top; }
        .summary-cell .label { font-size: 8pt; color: #64748b; text-transform: uppercase; margin-bottom: 5px; font-weight: 600; }
        .summary-cell .value { font-size: 13pt; font-weight: bold; color: #1e293b; }
        .summary-cell .sub { font-size: 8pt; color: #64748b; margin-top: 5px; }
        
        .section { margin-bottom: 20px; }
        .section-title { font-size: 11pt; font-weight: bold; color: #1e40af; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #cbd5e1; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        table thead { background: #f1f5f9; }
        table th { padding: 8px; text-align: left; font-size: 9pt; font-weight: 600; color: #475569; border-bottom: 2px solid #cbd5e1; }
        table td { padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 9pt; color: #1e293b; }
        table tbody tr:nth-child(even) { background: #f8fafc; }
        table tfoot { background: #e2e8f0; font-weight: bold; }
        
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        .footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #cbd5e1; text-align: center; font-size: 8pt; color: #64748b; }
        
        .two-col { display: table; width: 100%; margin-bottom: 15px; }
        .col { display: table-cell; width: 50%; padding: 0 8px; }
        .col:first-child { padding-left: 0; }
        .col:last-child { padding-right: 0; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 8pt; font-weight: 600; background: #dbeafe; color: #1e40af; }
        
        .rank-badge { display: inline-block; width: 20px; height: 20px; line-height: 20px; text-align: center; border-radius: 50%; font-weight: bold; color: white; margin-right: 5px; font-size: 8pt; }
        .rank-1 { background: #eab308; }
        .rank-2 { background: #9ca3af; }
        .rank-3 { background: #f97316; }
        .rank-other { background: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>LAPORAN KEUANGAN</h1>
            <h2>PAUD UNDIP</h2>
            <div class="payment-info">Sistem Pembayaran: Virtual Account BNI</div>
            <div class="metadata" style="margin-top: 10px;">
                <strong>Periode:</strong> 
                @if($granularity === 'monthly')
                    {{ \DateTime::createFromFormat('!m', $month)->format('F') }} {{ $year }}
                @else
                    Tahun {{ $year }}
                @endif
                | <strong>Dicetak:</strong> {{ $generatedAt->format('d F Y, H:i') }} WIB
            </div>
        </div>

        <div class="summary-grid">
            <div class="summary-row">
                <div class="summary-cell">
                    <div class="label">Total Pembayaran</div>
                    <div class="value">Rp {{ number_format($currentPeriodTotal, 0, ',', '.') }}</div>
                    <div class="sub" style="color: {{ $periodChangePercent >= 0 ? '#16a34a' : '#dc2626' }}">
                        {{ $periodChangePercent >= 0 ? '↗' : '↘' }} {{ number_format(abs($periodChangePercent), 1) }}% vs periode lalu
                    </div>
                </div>
                <div class="summary-cell">
                    <div class="label">Total Tagihan</div>
                    <div class="value">Rp {{ number_format($totalInvoiced, 0, ',', '.') }}</div>
                    <div class="sub">Koleksi: {{ number_format($collectionRate, 1) }}%</div>
                </div>
                <div class="summary-cell">
                    <div class="label">Tunggakan</div>
                    <div class="value" style="color: #dc2626;">Rp {{ number_format($totalOutstanding, 0, ',', '.') }}</div>
                    <div class="sub">{{ $totalInvoiced > 0 ? number_format(($totalOutstanding / $totalInvoiced) * 100, 1) : 0 }}% dari total</div>
                </div>
                <div class="summary-cell">
                    <div class="label">Total Diskon</div>
                    <div class="value">Rp {{ number_format($totalDiscounts, 0, ',', '.') }}</div>
                    <div class="sub">Potongan harga</div>
                </div>
            </div>
        </div>

        <div class="two-col">
            <div class="col">
                <table style="border: 1px solid #e2e8f0;">
                    <tr style="background: #f8fafc;">
                        <td style="width: 60%;"><strong>Rata-rata Transaksi</strong></td>
                        <td class="text-right">Rp {{ number_format($averageTransactionValue, 0, ',', '.') }}</td>
                    </tr>
                    <tr style="background: #f8fafc;">
                        <td><strong>Total Transaksi</strong></td>
                        <td class="text-right">{{ number_format($transactionCount, 0, ',', '.') }}</td>
                    </tr>
                </table>
            </div>
            <div class="col">
                <table style="border: 1px solid #e2e8f0;">
                    <tr style="background: #f8fafc;">
                        <td style="width: 60%;"><strong>Periode Sebelumnya</strong></td>
                        <td class="text-right">Rp {{ number_format($previousPeriodTotal, 0, ',', '.') }}</td>
                    </tr>
                    <tr style="background: #f8fafc;">
                        <td><strong>Perubahan</strong></td>
                        <td class="text-right" style="color: {{ $periodChangePercent >= 0 ? '#16a34a' : '#dc2626' }}">
                            {{ $periodChangePercent >= 0 ? '+' : '' }}{{ number_format($periodChangePercent, 1) }}%
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="two-col">
            <div class="col">
                <div class="section">
                    <div class="section-title">Laporan Agregat</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Periode</th>
                                <th class="text-center">Transaksi</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @forelse($reportRows as $row)
                                <tr>
                                    <td>
                                        @if($row['month'])
                                            {{ \DateTime::createFromFormat('!m', $row['month'])->format('M') }} {{ $row['year'] }}
                                        @else
                                            {{ $row['year'] }}
                                        @endif
                                    </td>
                                    <td class="text-center"><span class="badge">{{ $row['count'] }}</span></td>
                                    <td class="text-right"><strong>Rp {{ number_format($row['total_amount'], 0, ',', '.') }}</strong></td>
                                </tr>
                            @empty
                                <tr>
                                    <td colspan="3" class="text-center" style="padding: 15px; color: #64748b;">Tidak ada data</td>
                                </tr>
                            @endforelse
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col">
                <div class="section">
                    <div class="section-title">Sumber Pemasukan</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Sumber</th>
                                <th class="text-center">Item</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @php $grand = array_sum(array_column($incomeSources, 'total_amount') ?: [0]); @endphp
                            @forelse($incomeSources as $source)
                                @php $pct = $grand > 0 ? ($source['total_amount'] / $grand) * 100 : 0; @endphp
                                <tr>
                                    <td>
                                        <strong>{{ $source['income_type'] }}</strong><br>
                                        <span style="font-size: 8pt; color: #64748b;">{{ number_format($pct, 1) }}%</span>
                                    </td>
                                    <td class="text-center"><span class="badge">{{ $source['items_count'] }}</span></td>
                                    <td class="text-right">Rp {{ number_format($source['total_amount'], 0, ',', '.') }}</td>
                                </tr>
                            @empty
                                <tr>
                                    <td colspan="3" class="text-center" style="padding: 15px; color: #64748b;">Tidak ada data</td>
                                </tr>
                            @endforelse
                        </tbody>
                        @if(count($incomeSources) > 0)
                        <tfoot>
                            <tr>
                                <td><strong>TOTAL</strong></td>
                                <td class="text-center">{{ array_sum(array_column($incomeSources, 'items_count')) }}</td>
                                <td class="text-right">Rp {{ number_format($grand, 0, ',', '.') }}</td>
                            </tr>
                        </tfoot>
                        @endif
                    </table>
                </div>
            </div>
        </div>

        @if(!empty($topPayers))
        <div class="section">
            <div class="section-title">Siswa dengan Pembayaran Terbesar</div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">Rank</th>
                        <th>Nama Siswa</th>
                        <th>NIS</th>
                        <th class="text-center">Transaksi</th>
                        <th class="text-right">Total Pembayaran</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach($topPayers as $index => $payer)
                        <tr>
                            <td class="text-center">
                                <span class="rank-badge rank-{{ $index < 3 ? $index + 1 : 'other' }}">
                                    {{ $index + 1 }}
                                </span>
                            </td>
                            <td><strong>{{ $payer['name'] }}</strong></td>
                            <td>{{ $payer['nis'] }}</td>
                            <td class="text-center"><span class="badge">{{ $payer['payment_count'] }}</span></td>
                            <td class="text-right"><strong>Rp {{ number_format($payer['total_paid'], 0, ',', '.') }}</strong></td>
                        </tr>
                    @endforeach
                </tbody>
            </table>
        </div>
        @endif

        <div class="footer">
            <p><strong>PAUD UNDIP</strong> - Sistem Informasi Keuangan</p>
            <p style="margin-top: 5px;">Laporan dihasilkan secara otomatis pada {{ $generatedAt->format('d F Y, H:i:s') }} WIB</p>
            <p style="margin-top: 3px;">Pembayaran melalui Virtual Account BNI | Untuk informasi lebih lanjut hubungi bagian keuangan</p>
        </div>
    </div>
</body>
</html>
